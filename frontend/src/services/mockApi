// src/services/mockApi.js

export const mockApi = {
  async submitAnswer(answerInput: { user_answer: any; }) {
    // 1. Extract string if input is an object
    const answer = typeof answerInput === 'object' ? answerInput.user_answer : answerInput;

    // Simulate network delay for realism
    await new Promise(resolve => setTimeout(resolve, 800));

    // Handle empty or null cases
    if (!answer) return { next_probe: "Please provide an explanation.", score: 100, responseType: 'long_answer' };

    const lowerAnswer = answer.toLowerCase();

    // 2. TERMINAL FAILURE: "Very very far off" [cite: 195-197]
    // Triggered if they admit ignorance or use keywords indicating complete confusion
    if (lowerAnswer.includes("don't know") || lowerAnswer.includes("no idea") || lowerAnswer.includes("guess")) {
      return {
        next_probe: "Evaluation Terminated.",
        score: 15,
        responseType: 'terminal_failure', // Ends the convo [cite: 195]
        explanation: "You are relying on recall rather than semantic understanding. Your reasoning collapsed when the context shifted." // [cite: 49, 131]
      };
    }

    // 3. MCQ MODE: "Close but not 100% correct" [cite: 177, 181-184]
    // Triggered by short, shallow answers that only scratch the surface
    if (answer.length < 20) {
      return {
        next_probe: "That's a bit shallow. To verify your understanding, which of these happens in an INNER JOIN?",
        score: 45, // Brittle understanding score [cite: 70]
        responseType: 'mcq', // Display options like Google Forms [cite: 177, 181]
        options: [
          "Returns only rows with matching keys in both tables", 
          "Includes all rows from the left table regardless of matches", 
          "Returns a Cartesian product of both datasets", 
          "Filters out NULLs from the primary key only"
        ]
      };
    }

    // 4. LONG ANSWER: Initial probing or "a bit far off" [cite: 178, 189-191]
    // This represents the "Adversarial follow-up" questioning [cite: 125]
    return {
      next_probe: "Reasoning accepted. Now, consider a constraint shift: If we add 'WHERE table2.id IS NULL' to a LEFT JOIN, how does the semantic meaning change?",
      score: 85, // Stable understanding [cite: 69]
      responseType: 'long_answer', // Requires Typing Inter [cite: 191]
      metadata: {
        // Visual table data for the "Wow" moment [cite: 45, 82]
        table_data: [
          { id: 1, user: "Alice", order_id: 101 },
          { id: 2, user: "Bob", order_id: "NULL" }
        ]
      }
    };
  }
};